{% extends "layouts/dashboard.html" %}
{% from "components/modals.html" import modal_dialog %}
{% from "components/forms.html" import form_field, form_select, form_textarea, form_file, form_checkbox %}
{% from "components/cards.html" import document_card %}
{% from "components/pagination.html" import render_pagination %}

{% set page_title = "Documentos" %}
{% set active_menu = "documents" %}

{% block extra_css %}
<link href="{{ url_for('static', filename='vendor/dropzone/dropzone.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='vendor/pdf-viewer/pdf-viewer.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='vendor/file-icons/file-icons.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='vendor/sortable/sortable.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='vendor/lightbox/lightbox.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='dist/css/documents.css') }}" rel="stylesheet">
<style>
:root {
    --primary-color: #007bff;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --info-color: #17a2b8;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
}

.documents-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 0;
}

.main-content {
    background: white;
    border-radius: 15px 0 0 0;
    min-height: calc(100vh - 100px);
    margin-top: 20px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, var(--card-gradient, #667eea 0%, #764ba2 100%));
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.1);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
}

.stat-card:hover::before {
    transform: translateX(0);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.stat-card .stat-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.9;
}

.stat-card .stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.document-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
}

.document-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    border: 1px solid #e9ecef;
}

.document-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    border-color: var(--primary-color);
}

.document-card.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
}

.document-preview {
    height: 220px;
    background: linear-gradient(45deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.document-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.document-card:hover .document-preview img {
    transform: scale(1.05);
}

.file-icon {
    font-size: 4.5rem;
    opacity: 0.7;
    transition: all 0.3s ease;
}

.document-card:hover .file-icon {
    transform: scale(1.1);
    opacity: 0.9;
}

.document-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
    padding: 15px;
    display: flex;
    justify-content: between;
    align-items: flex-start;
}

.document-status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-draft { background: #fff3cd; color: #856404; }
.status-review { background: #cce5ff; color: #004085; }
.status-approved { background: #d4edda; color: #155724; }
.status-rejected { background: #f8d7da; color: #721c24; }
.status-archived { background: #e2e3e5; color: #383d41; }

.document-actions {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.document-card:hover .document-actions {
    opacity: 1;
}

.document-info {
    padding: 20px;
}

.document-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark-color);
    line-height: 1.3;
}

.document-meta {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 12px;
    font-size: 0.85rem;
    color: #6c757d;
}

.document-size {
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.document-description {
    font-size: 0.9rem;
    color: #6c757d;
    line-height: 1.4;
    margin-bottom: 15px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.document-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 15px;
}

.tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.sharing-info {
    display: flex;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.sharing-avatars {
    display: flex;
    margin-right: 10px;
}

.sharing-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid white;
    margin-right: -8px;
    transition: transform 0.2s ease;
}

.sharing-avatar:hover {
    transform: scale(1.1);
    z-index: 1;
    position: relative;
}

.sidebar {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    overflow: hidden;
}

.sidebar-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.sidebar-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    color: var(--dark-color);
    display: flex;
    align-items: center;
}

.sidebar-title i {
    margin-right: 10px;
    color: var(--primary-color);
}

.sidebar-content {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.folder-tree {
    list-style: none;
    padding: 0;
    margin: 0;
}

.folder-item {
    padding: 12px 16px;
    margin: 2px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: between;
}

.folder-item:hover {
    background: #f8f9fa;
}

.folder-item.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    font-weight: 500;
}

.folder-icon {
    margin-right: 12px;
    font-size: 1.1rem;
    color: #ffc107;
}

.folder-item.active .folder-icon {
    color: white;
}

.folder-count {
    background: rgba(0,0,0,0.1);
    color: inherit;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 500;
}

.filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 15px 0;
}

.filter-chip {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    border-radius: 25px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
    display: flex;
    align-items: center;
}

.filter-chip i {
    margin-right: 6px;
}

.filter-chip:hover,
.filter-chip.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateY(-1px);
}

.upload-zone {
    border: 3px dashed #dee2e6;
    border-radius: 12px;
    padding: 50px 30px;
    text-align: center;
    background: linear-gradient(45deg, #fafafa 0%, #f8f9fa 100%);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.upload-zone::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(0,123,255,0.05) 0%, rgba(0,123,255,0.1) 100%);
    transform: scale(0);
    transition: transform 0.3s ease;
    border-radius: 12px;
}

.upload-zone.dragover::before,
.upload-zone:hover::before {
    transform: scale(1);
}

.upload-zone.dragover {
    border-color: var(--primary-color);
    background: rgba(0,123,255,0.05);
}

.upload-icon {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.upload-zone:hover .upload-icon {
    color: var(--primary-color);
    transform: scale(1.1);
}

.breadcrumb-nav {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
}

.breadcrumb {
    margin: 0;
    background: none;
    padding: 0;
}

.breadcrumb-item {
    font-size: 0.9rem;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: #6c757d;
    font-weight: bold;
}

.breadcrumb-item.active {
    color: var(--primary-color);
    font-weight: 500;
}

.search-filters {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
}

.bulk-actions {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: #856404;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.bulk-actions.show {
    display: flex;
    justify-content: between;
    align-items: center;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.document-viewer {
    height: 70vh;
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e9ecef;
    position: relative;
}

.viewer-toolbar {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: between;
    align-items: center;
    border-bottom: 1px solid #495057;
}

.viewer-content {
    height: calc(100% - 60px);
    overflow: auto;
    background: white;
}

.comment-thread {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
}

.comment-item {
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    background: white;
    margin: 5px;
    border-radius: 6px;
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-author {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

.comment-author img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 8px;
}

.comment-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-left: auto;
}

.comment-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--dark-color);
}

.version-timeline {
    max-height: 350px;
    overflow-y: auto;
}

.version-item {
    padding: 15px;
    border-left: 4px solid #e9ecef;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
    position: relative;
    transition: all 0.2s ease;
}

.version-item:hover {
    background: #e3f2fd;
    border-left-color: var(--primary-color);
}

.version-item.current {
    border-left-color: var(--success-color);
    background: #f0fff4;
}

.version-badge {
    position: absolute;
    top: 15px;
    left: -8px;
    background: white;
    border: 3px solid var(--success-color);
    border-radius: 50%;
    width: 16px;
    height: 16px;
}

.version-info {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.version-number {
    font-weight: 600;
    color: var(--dark-color);
}

.version-date {
    font-size: 0.8rem;
    color: #6c757d;
}

.version-changes {
    font-size: 0.85rem;
    color: #495057;
    line-height: 1.4;
}

.document-select {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 2;
    display: none;
}

.document-select input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.quick-actions {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.quick-action-btn {
    display: block;
    width: 100%;
    text-align: left;
    padding: 12px 16px;
    margin-bottom: 8px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: white;
    color: var(--dark-color);
    text-decoration: none;
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    text-decoration: none;
    transform: translateX(5px);
}

.quick-action-btn i {
    margin-right: 10px;
    width: 20px;
}

.empty-state {
    text-align: center;
    padding: 80px 40px;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 6rem;
    margin-bottom: 30px;
    opacity: 0.3;
}

.empty-state h3 {
    margin-bottom: 15px;
    color: var(--dark-color);
}

.empty-state p {
    margin-bottom: 30px;
    font-size: 1.1rem;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .document-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .filter-chips {
        justify-content: center;
    }
    
    .search-filters {
        padding: 15px;
    }
    
    .document-card {
        margin: 0 10px;
    }
    
    .upload-zone {
        padding: 30px 15px;
    }
    
    .sidebar-content {
        max-height: 250px;
    }
}

@media (max-width: 576px) {
    .main-content {
        border-radius: 0;
        margin-top: 0;
    }
    
    .stat-card {
        padding: 20px 15px;
    }
    
    .document-info {
        padding: 15px;
    }
    
    .bulk-actions {
        flex-direction: column;
        gap: 10px;
    }
}

/* Print Styles */
@media print {
    .sidebar,
    .document-actions,
    .bulk-actions,
    .search-filters {
        display: none !important;
    }
    
    .document-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .document-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .document-card {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    .sidebar {
        background: #2d3748;
        color: #e2e8f0;
    }
    
    .search-filters {
        background: #2d3748;
        color: #e2e8f0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="documents-container">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="h3 text-white mb-2">
                            <i class="fas fa-folder-open me-2"></i>
                            Centro de Documentos
                        </h2>
                        <p class="text-white-50 mb-0">Organiza, colabora y gestiona todos tus documentos empresariales</p>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- View Toggle -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light active" data-view="grid">
                                <i class="fas fa-th"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                        
                        <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#templatesModal">
                            <i class="fas fa-file-contract me-1"></i>
                            Plantillas
                        </button>
                        <button type="button" class="btn btn-outline-light" onclick="syncWithCloud()">
                            <i class="fab fa-google-drive me-1"></i>
                            Sincronizar
                        </button>
                        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-cloud-upload-alt me-1"></i>
                            Subir Documento
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="container-fluid p-4">
                <!-- Document Stats -->
                <div class="stats-grid">
                    <div class="stat-card" style="--card-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-files"></i>
                        </div>
                        <div class="stat-number">{{ document_stats.total or 0 }}</div>
                        <div class="stat-label">Total Documentos</div>
                    </div>
                    <div class="stat-card" style="--card-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-hdd"></i>
                        </div>
                        <div class="stat-number">{{ "%.1f"|format(document_stats.total_size_mb or 0) }}</div>
                        <div class="stat-label">MB Utilizados</div>
                    </div>
                    <div class="stat-card" style="--card-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-share-alt"></i>
                        </div>
                        <div class="stat-number">{{ document_stats.shared or 0 }}</div>
                        <div class="stat-label">Compartidos</div>
                    </div>
                    <div class="stat-card" style="--card-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number">{{ document_stats.recent or 0 }}</div>
                        <div class="stat-label">Esta Semana</div>
                    </div>
                </div>

                <div class="row">
                    <!-- Sidebar -->
                    <div class="col-lg-3">
                        <!-- Folder Navigation -->
                        <div class="sidebar">
                            <div class="sidebar-header">
                                <h6 class="sidebar-title">
                                    <i class="fas fa-folder-tree"></i>
                                    Estructura de Carpetas
                                </h6>
                            </div>
                            <div class="sidebar-content">
                                <ul class="folder-tree">
                                    <li class="folder-item active" data-folder-id="all">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="fas fa-home folder-icon"></i>
                                            <span class="flex-grow-1">Todos los documentos</span>
                                            <span class="folder-count">{{ document_stats.total or 0 }}</span>
                                        </div>
                                    </li>
                                    {% for folder in document_folders %}
                                    <li class="folder-item" data-folder-id="{{ folder.id }}" style="padding-left: {{ (folder.level * 25 + 16) }}px;">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="fas fa-folder folder-icon"></i>
                                            <span class="flex-grow-1">{{ folder.name }}</span>
                                            <span class="folder-count">{{ folder.document_count }}</span>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                
                                <hr class="my-3">
                                
                                <!-- Smart Folders -->
                                <ul class="folder-tree">
                                    <li class="folder-item" data-filter="recent">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="fas fa-clock text-info"></i>
                                            <span class="flex-grow-1 ms-2">Recientes</span>
                                        </div>
                                    </li>
                                    <li class="folder-item" data-filter="shared">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="fas fa-users text-success"></i>
                                            <span class="flex-grow-1 ms-2">Compartidos conmigo</span>
                                        </div>
                                    </li>
                                    <li class="folder-item" data-filter="starred">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="fas fa-star text-warning"></i>
                                            <span class="flex-grow-1 ms-2">Favoritos</span>
                                        </div>
                                    </li>
                                    <li class="folder-item" data-filter="pending">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="fas fa-exclamation-triangle text-danger"></i>
                                            <span class="flex-grow-1 ms-2">Pendientes de revisión</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- File Type Filters -->
                        <div class="sidebar">
                            <div class="sidebar-header">
                                <h6 class="sidebar-title">
                                    <i class="fas fa-filter"></i>
                                    Filtrar por Tipo
                                </h6>
                            </div>
                            <div class="sidebar-content">
                                <div class="filter-chips">
                                    <div class="filter-chip active" data-type="all">
                                        <i class="fas fa-files"></i>
                                        Todos
                                    </div>
                                    <div class="filter-chip" data-type="pdf">
                                        <i class="fas fa-file-pdf"></i>
                                        PDF
                                    </div>
                                    <div class="filter-chip" data-type="doc">
                                        <i class="fas fa-file-word"></i>
                                        Word
                                    </div>
                                    <div class="filter-chip" data-type="xls">
                                        <i class="fas fa-file-excel"></i>
                                        Excel
                                    </div>
                                    <div class="filter-chip" data-type="ppt">
                                        <i class="fas fa-file-powerpoint"></i>
                                        PowerPoint
                                    </div>
                                    <div class="filter-chip" data-type="img">
                                        <i class="fas fa-file-image"></i>
                                        Imágenes
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <h6 class="sidebar-title mb-3">
                                <i class="fas fa-lightning-bolt"></i>
                                Acciones Rápidas
                            </h6>
                            <a href="#" class="quick-action-btn" onclick="createFromTemplate('business_plan')">
                                <i class="fas fa-briefcase"></i>
                                Nuevo Plan de Negocio
                            </a>
                            <a href="#" class="quick-action-btn" onclick="createFromTemplate('financial_projection')">
                                <i class="fas fa-chart-line"></i>
                                Proyección Financiera
                            </a>
                            <a href="#" class="quick-action-btn" onclick="createFromTemplate('pitch_deck')">
                                <i class="fas fa-presentation"></i>
                                Nuevo Pitch Deck
                            </a>
                            <a href="#" class="quick-action-btn" onclick="scanDocument()">
                                <i class="fas fa-camera"></i>
                                Escanear Documento
                            </a>
                            <a href="#" class="quick-action-btn" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                                <i class="fas fa-folder-plus"></i>
                                Nueva Carpeta
                            </a>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="col-lg-9">
                        <!-- Breadcrumb Navigation -->
                        <div class="breadcrumb-nav">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb" id="folderBreadcrumb">
                                    <li class="breadcrumb-item">
                                        <a href="#" onclick="navigateToFolder('all')" class="text-decoration-none">
                                            <i class="fas fa-home me-1"></i>
                                            Inicio
                                        </a>
                                    </li>
                                    <!-- Dynamic breadcrumb items will be inserted here -->
                                </ol>
                            </nav>
                        </div>

                        <!-- Search and Filters -->
                        <div class="search-filters">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="documentSearch" 
                                               placeholder="Buscar en documentos, contenido, etiquetas..." 
                                               value="{{ request.args.get('search', '') }}">
                                        <button class="btn btn-outline-secondary" type="button" onclick="advancedSearch()">
                                            <i class="fas fa-sliders-h"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="sortBy">
                                        <option value="updated_desc">Más reciente</option>
                                        <option value="name_asc">Nombre A-Z</option>
                                        <option value="name_desc">Nombre Z-A</option>
                                        <option value="size_desc">Mayor tamaño</option>
                                        <option value="size_asc">Menor tamaño</option>
                                        <option value="views_desc">Más visto</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Todos los estados</option>
                                        <option value="draft">Borrador</option>
                                        <option value="review">En revisión</option>
                                        <option value="approved">Aprobado</option>
                                        <option value="rejected">Rechazado</option>
                                        <option value="archived">Archivado</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="toggleBulkSelect()">
                                        <i class="fas fa-check-square me-1"></i>
                                        Seleccionar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="bulk-actions" id="bulkActions">
                            <div>
                                <strong id="selectedCount">0 documentos seleccionados</strong>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-dark" onclick="bulkDownload()">
                                    <i class="fas fa-download me-1"></i>
                                    Descargar
                                </button>
                                <button type="button" class="btn btn-sm btn-dark" onclick="bulkShare()">
                                    <i class="fas fa-share me-1"></i>
                                    Compartir
                                </button>
                                <button type="button" class="btn btn-sm btn-dark" onclick="bulkMove()">
                                    <i class="fas fa-folder me-1"></i>
                                    Mover
                                </button>
                                <button type="button" class="btn btn-sm btn-dark" onclick="bulkArchive()">
                                    <i class="fas fa-archive me-1"></i>
                                    Archivar
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()">
                                    <i class="fas fa-trash me-1"></i>
                                    Eliminar
                                </button>
                            </div>
                        </div>

                        <!-- Documents Grid/List -->
                        <div id="documentsContainer">
                            {% if documents %}
                                <div class="document-grid" id="documentGrid">
                                    {% for document in documents %}
                                    <div class="document-card" data-document-id="{{ document.id }}" data-file-type="{{ document.file_extension }}">
                                        <!-- Document Header -->
                                        <div class="document-header">
                                            <div class="document-status status-{{ document.status }}">
                                                {{ document.get_status_display() }}
                                            </div>
                                            <div class="document-actions">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-light btn-sm" onclick="viewDocument({{ document.id }})">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item" href="#" onclick="downloadDocument({{ document.id }})">
                                                            <i class="fas fa-download me-2"></i>Descargar
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="shareDocument({{ document.id }})">
                                                            <i class="fas fa-share me-2"></i>Compartir
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="editDocument({{ document.id }})">
                                                            <i class="fas fa-edit me-2"></i>Editar
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="viewVersions({{ document.id }})">
                                                            <i class="fas fa-history me-2"></i>Historial
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="duplicateDocument({{ document.id }})">
                                                            <i class="fas fa-copy me-2"></i>Duplicar
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="toggleFavorite({{ document.id }})">
                                                            <i class="fas fa-star me-2"></i>
                                                            {{ 'Quitar de favoritos' if document.is_favorite else 'Añadir a favoritos' }}
                                                        </a></li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument({{ document.id }})">
                                                            <i class="fas fa-trash me-2"></i>Eliminar
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Selection Checkbox -->
                                        <div class="document-select">
                                            <input type="checkbox" class="form-check-input" value="{{ document.id }}" onchange="updateSelectedCount()">
                                        </div>

                                        <!-- Document Preview -->
                                        <div class="document-preview" onclick="viewDocument({{ document.id }})">
                                            {% if document.has_thumbnail %}
                                            <img src="{{ document.thumbnail_url }}" alt="{{ document.title }}" loading="lazy">
                                            {% else %}
                                            {% set file_ext = document.file_extension.lower() %}
                                            {% if file_ext == 'pdf' %}
                                            <i class="fas fa-file-pdf file-icon text-danger"></i>
                                            {% elif file_ext in ['doc', 'docx'] %}
                                            <i class="fas fa-file-word file-icon text-primary"></i>
                                            {% elif file_ext in ['xls', 'xlsx'] %}
                                            <i class="fas fa-file-excel file-icon text-success"></i>
                                            {% elif file_ext in ['ppt', 'pptx'] %}
                                            <i class="fas fa-file-powerpoint file-icon text-warning"></i>
                                            {% elif file_ext in ['jpg', 'jpeg', 'png', 'gif', 'svg'] %}
                                            <i class="fas fa-file-image file-icon text-info"></i>
                                            {% elif file_ext in ['mp4', 'avi', 'mov', 'wmv'] %}
                                            <i class="fas fa-file-video file-icon text-danger"></i>
                                            {% elif file_ext in ['mp3', 'wav', 'flac'] %}
                                            <i class="fas fa-file-audio file-icon text-warning"></i>
                                            {% elif file_ext in ['zip', 'rar', '7z'] %}
                                            <i class="fas fa-file-archive file-icon text-secondary"></i>
                                            {% else %}
                                            <i class="fas fa-file file-icon text-muted"></i>
                                            {% endif %}
                                            {% endif %}
                                            
                                            {% if document.is_favorite %}
                                            <i class="fas fa-star position-absolute top-0 end-0 m-3 text-warning"></i>
                                            {% endif %}
                                        </div>

                                        <!-- Document Info -->
                                        <div class="document-info">
                                            <h6 class="document-title" title="{{ document.title }}">
                                                {{ document.title[:50] }}{% if document.title|length > 50 %}...{% endif %}
                                            </h6>
                                            
                                            <div class="document-meta">
                                                <span class="document-size">{{ document.file_size_human }}</span>
                                                <span class="text-muted">v{{ document.version }}</span>
                                            </div>
                                            
                                            {% if document.description %}
                                            <div class="document-description">
                                                {{ document.description }}
                                            </div>
                                            {% endif %}

                                            <div class="d-flex justify-content-between align-items-center text-muted small">
                                                <span>
                                                    <i class="fas fa-clock me-1"></i>
                                                    {{ document.updated_at|timeago }}
                                                </span>
                                                {% if document.view_count %}
                                                <span>
                                                    <i class="fas fa-eye me-1"></i>
                                                    {{ document.view_count }}
                                                </span>
                                                {% endif %}
                                            </div>

                                            {% if document.project %}
                                            <div class="mt-2">
                                                <span class="badge bg-light text-dark">
                                                    <i class="fas fa-project-diagram me-1"></i>
                                                    {{ document.project.name }}
                                                </span>
                                            </div>
                                            {% endif %}

                                            <!-- Tags -->
                                            {% if document.tags %}
                                            <div class="document-tags">
                                                {% for tag in document.tags[:3] %}
                                                <span class="tag">{{ tag.name }}</span>
                                                {% endfor %}
                                                {% if document.tags|length > 3 %}
                                                <span class="tag">+{{ document.tags|length - 3 }}</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}

                                            <!-- Sharing Info -->
                                            {% if document.shared_with %}
                                            <div class="sharing-info">
                                                <div class="sharing-avatars">
                                                    {% for user in document.shared_with[:4] %}
                                                    <img src="{{ user.avatar_url or url_for('static', filename='img/default-avatar.png') }}" 
                                                         alt="{{ user.full_name }}" 
                                                         class="sharing-avatar"
                                                         title="{{ user.full_name }}">
                                                    {% endfor %}
                                                </div>
                                                <small class="text-muted">
                                                    Compartido con {{ document.shared_with|length }} 
                                                    {{ 'persona' if document.shared_with|length == 1 else 'personas' }}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Pagination -->
                                {% if pagination and pagination.pages > 1 %}
                                <div class="mt-4">
                                    {{ render_pagination(pagination, 'entrepreneur.documents') }}
                                </div>
                                {% endif %}
                            {% else %}
                                <!-- Empty State -->
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-folder-open"></i>
                                    </div>
                                    <h3>No hay documentos en esta ubicación</h3>
                                    <p>Comienza subiendo tu primer documento o creando uno desde una plantilla</p>
                                    <div class="d-flex gap-3 justify-content-center">
                                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>
                                            Subir Documento
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#templatesModal">
                                            <i class="fas fa-file-contract me-2"></i>
                                            Ver Plantillas
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Loading State -->
                        <div id="loadingState" class="loading-spinner" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="uploadForm" method="POST" enctype="multipart/form-data">
                {{ csrf_token() }}
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cloud-upload-alt me-2"></i>
                        Subir Documentos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Drag & Drop Zone -->
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-content">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h5 class="mb-3">Arrastra y suelta archivos aquí</h5>
                            <p class="text-muted mb-4">o haz clic para seleccionar archivos desde tu dispositivo</p>
                            <input type="file" class="d-none" id="fileInput" name="files[]" multiple 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.svg,.mp4,.avi,.mov,.mp3,.wav,.zip,.rar">
                            <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open me-2"></i>
                                Seleccionar Archivos
                            </button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    Formatos soportados: Documentos (PDF, Word, Excel, PowerPoint), 
                                    Imágenes (JPG, PNG, GIF, SVG), Videos, Audio, Archivos comprimidos
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- File List -->
                    <div id="fileList" class="mt-4" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fas fa-list me-2"></i>
                            Archivos seleccionados:
                        </h6>
                        <div id="selectedFiles" class="border rounded p-3 bg-light">
                            <!-- Selected files will be displayed here -->
                        </div>
                    </div>

                    <!-- Document Configuration -->
                    <div class="row g-3 mt-4">
                        <div class="col-12">
                            <h6 class="mb-3">
                                <i class="fas fa-cogs me-2"></i>
                                Configuración de Documentos
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_select('folder_id', 'Carpeta de Destino', options=document_folders,
                                          option_value='id', option_text='name', 
                                          help_text='Selecciona dónde guardar los documentos') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_select('project_id', 'Proyecto Asociado (Opcional)', options=user_projects,
                                          option_value='id', option_text='name',
                                          help_text='Vincula los documentos a un proyecto específico') }}
                        </div>
                        
                        <div class="col-12">
                            {{ form_field('tags', 'Etiquetas',
                                         placeholder='emprendimiento, finanzas, legal, marketing...',
                                         help_text='Separa las etiquetas con comas para facilitar la búsqueda') }}
                        </div>
                        
                        <div class="col-12">
                            {{ form_textarea('description', 'Descripción General', rows=3,
                                           placeholder='Descripción que se aplicará a todos los documentos subidos...',
                                           help_text='Esta descripción se puede personalizar individualmente después') }}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form_select('visibility', 'Visibilidad', options=[
                                ('private', 'Privado - Solo yo'),
                                ('team', 'Equipo - Mi equipo de proyecto'),
                                ('mentor', 'Mentores - Mis mentores asignados'),
                                ('program', 'Programa - Participantes del programa'),
                                ('public', 'Público - Visible para todos')
                            ], help_text='Define quién puede ver estos documentos') }}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form_select('default_status', 'Estado Inicial', options=[
                                ('draft', 'Borrador'),
                                ('review', 'Listo para revisión'),
                                ('final', 'Versión final')
                            ], help_text='Estado inicial de los documentos') }}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form_checkbox('auto_ocr', 'Extraer texto automáticamente (OCR)', 
                                           help_text='Permite búsqueda de contenido en PDFs e imágenes') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_checkbox('notify_watchers', 'Notificar a seguidores',
                                           help_text='Envía notificaciones a personas que siguen tus documentos') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_checkbox('sync_cloud', 'Sincronizar con la nube',
                                           help_text='Crear copia de seguridad automática en Google Drive') }}
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-4" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fas fa-upload me-2"></i>
                            Progreso de Subida
                        </h6>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted" id="uploadStatusText">Preparando archivos...</small>
                            <small class="text-muted">
                                <span id="uploadedCount">0</span> de <span id="totalCount">0</span> archivos
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                        <i class="fas fa-cloud-upload-alt me-1"></i>
                        Subir <span id="fileCount">0</span> Documentos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createFolderForm" method="POST">
                {{ csrf_token() }}
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-plus me-2"></i>
                        Nueva Carpeta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            {{ form_field('folder_name', 'Nombre de la Carpeta', required=True,
                                         placeholder='Ej: Documentos Legales, Finanzas Q1, Marketing Digital...',
                                         help_text='El nombre debe ser descriptivo y único') }}
                        </div>
                        
                        <div class="col-12">
                            {{ form_select('parent_folder_id', 'Carpeta Padre (Opcional)', options=document_folders,
                                          option_value='id', option_text='name',
                                          help_text='Deja vacío para crear en el nivel raíz') }}
                        </div>
                        
                        <div class="col-12">
                            {{ form_textarea('folder_description', 'Descripción', rows=3,
                                           placeholder='Describe el propósito y contenido de esta carpeta...',
                                           help_text='Ayuda a otros a entender qué tipo de documentos encontrarán aquí') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_field('folder_color', 'Color de Identificación', type='color', value='#007bff',
                                         help_text='Color para identificar visualmente la carpeta') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_select('folder_template', 'Plantilla de Carpeta', options=[
                                ('', 'Carpeta básica'),
                                ('project', 'Carpeta de proyecto'),
                                ('legal', 'Documentos legales'),
                                ('financial', 'Documentos financieros'),
                                ('marketing', 'Materiales de marketing')
                            ], help_text='Estructura predefinida para organizar documentos') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_checkbox('folder_shared', 'Carpeta compartida',
                                           help_text='Permite que otros miembros accedan a esta carpeta') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_checkbox('auto_organize', 'Organización automática',
                                           help_text='Organiza automáticamente los documentos por tipo') }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-folder-plus me-1"></i>
                        Crear Carpeta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewerTitle">
                    <i class="fas fa-file me-2"></i>
                    Visor de Documentos
                </h5>
                <div class="viewer-controls">
                    <div class="btn-group me-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="zoomOut()">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetZoom()">
                            100%
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="zoomIn()">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="downloadCurrentDocument()">
                            <i class="fas fa-download"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printCurrentDocument()">
                            <i class="fas fa-print"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="shareCurrentDocument()">
                            <i class="fas fa-share"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row h-100">
                    <!-- Main Viewer -->
                    <div class="col-lg-9">
                        <div class="document-viewer">
                            <div class="viewer-toolbar">
                                <div class="d-flex align-items-center">
                                    <span id="currentDocumentInfo" class="text-light"></span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="previousPage()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span class="text-light me-2">
                                        Página <span id="currentPage">1</span> de <span id="totalPages">1</span>
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-light" onclick="nextPage()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="viewer-content" id="documentViewer">
                                <!-- Document content will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
                    <div class="col-lg-3 border-start bg-light">
                        <div class="p-3 h-100 overflow-auto">
                            <!-- Document Information -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información
                                </h6>
                                <div id="documentInfo">
                                    <!-- Document details will be loaded here -->
                                </div>
                            </div>

                            <!-- Comments Section -->
                            <div class="mb-4">
                                <h6 class="mb-3 d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-comments me-2"></i>
                                        Comentarios
                                    </span>
                                    <span class="badge bg-primary" id="commentCount">0</span>
                                </h6>
                                
                                <!-- Add Comment Form -->
                                <form id="addCommentForm" class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" 
                                               placeholder="Añadir comentario..." name="comment_text" required>
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                                
                                <!-- Comments List -->
                                <div class="comment-thread" id="commentThread">
                                    <!-- Comments will be loaded here -->
                                </div>
                            </div>

                            <!-- Version History -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="fas fa-history me-2"></i>
                                    Historial de Versiones
                                </h6>
                                <div class="version-timeline" id="versionTimeline">
                                    <!-- Version history will be loaded here -->
                                </div>
                            </div>

                            <!-- Sharing Information -->
                            <div>
                                <h6 class="mb-3">
                                    <i class="fas fa-users me-2"></i>
                                    Compartido con
                                </h6>
                                <div id="sharingInfo">
                                    <!-- Sharing information will be loaded here -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="shareCurrentDocument()">
                                    <i class="fas fa-user-plus me-1"></i>
                                    Compartir con más personas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Document Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="shareForm" method="POST">
                {{ csrf_token() }}
                <input type="hidden" name="document_id" id="shareDocumentId">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-share me-2"></i>
                        Compartir Documento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <h6 class="mb-3">Compartir con personas específicas</h6>
                            <select class="form-select" name="share_with[]" multiple size="6">
                                <optgroup label="Mentores">
                                    {% for mentor in user_mentors %}
                                    <option value="mentor:{{ mentor.id }}">
                                        {{ mentor.full_name }} - {{ mentor.specialization }}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Aliados">
                                    {% for ally in user_allies %}
                                    <option value="ally:{{ ally.id }}">
                                        {{ ally.full_name }} - {{ ally.organization }}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Compañeros Emprendedores">
                                    {% for peer in program_peers %}
                                    <option value="entrepreneur:{{ peer.id }}">
                                        {{ peer.full_name }} - {{ peer.company_name }}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <div class="form-text">Mantén presionado Ctrl/Cmd para seleccionar múltiples personas</div>
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_select('permission_level', 'Nivel de Permisos', options=[
                                ('view', 'Solo lectura - Pueden ver el documento'),
                                ('comment', 'Lectura y comentarios - Pueden comentar'),
                                ('edit', 'Editar - Pueden modificar el documento'),
                                ('admin', 'Administrador - Control total')
                            ], help_text='Define qué pueden hacer con el documento') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_field('expiration_date', 'Fecha de Expiración (Opcional)', type='date',
                                         help_text='El acceso se revocará automáticamente en esta fecha') }}
                        </div>
                        
                        <div class="col-12">
                            {{ form_textarea('share_message', 'Mensaje Personal (Opcional)', rows=3,
                                           placeholder='Escribe un mensaje para acompañar el documento compartido...',
                                           help_text='Este mensaje se incluirá en la notificación por correo') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_checkbox('notify_recipients', 'Notificar por correo electrónico', checked=True,
                                           help_text='Envía notificación inmediata a los destinatarios') }}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form_checkbox('allow_download', 'Permitir descarga', checked=True,
                                           help_text='Los usuarios pueden descargar una copia del documento') }}
                        </div>
                        
                        <div class="col-12">
                            <hr>
                            <h6 class="mb-3">Enlace de acceso público</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" id="publicLink" readonly 
                                       placeholder="Generar enlace público...">
                                <button type="button" class="btn btn-outline-secondary" onclick="generatePublicLink()">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="copyPublicLink()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="form-text">Cualquier persona con este enlace podrá acceder al documento</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-share me-1"></i>
                        Compartir Documento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-contract me-2"></i>
                    Biblioteca de Plantillas Empresariales
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Template Categories -->
                <div class="filter-chips mb-4">
                    <div class="filter-chip active" data-category="all">
                        <i class="fas fa-th-large"></i>
                        Todas las Plantillas
                    </div>
                    <div class="filter-chip" data-category="business">
                        <i class="fas fa-briefcase"></i>
                        Plan de Negocio
                    </div>
                    <div class="filter-chip" data-category="financial">
                        <i class="fas fa-chart-line"></i>
                        Financieras
                    </div>
                    <div class="filter-chip" data-category="legal">
                        <i class="fas fa-gavel"></i>
                        Legales
                    </div>
                    <div class="filter-chip" data-category="marketing">
                        <i class="fas fa-bullhorn"></i>
                        Marketing
                    </div>
                    <div class="filter-chip" data-category="pitch">
                        <i class="fas fa-presentation"></i>
                        Presentaciones
                    </div>
                </div>

                <!-- Templates Grid -->
                <div class="row g-4">
                    {% for template in document_templates %}
                    <div class="col-lg-4 col-md-6 template-item" data-category="{{ template.category }}">
                        <div class="card border-0 shadow-sm h-100 template-card" onclick="useTemplate('{{ template.id }}')">
                            <div class="card-img-top position-relative">
                                <img src="{{ template.preview_url or url_for('static', filename='img/template-preview.png') }}" 
                                     alt="{{ template.name }}" class="img-fluid" style="height: 200px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-primary">{{ template.category|title }}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">{{ template.name }}</h6>
                                <p class="card-text small text-muted">{{ template.description }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-download me-1"></i>
                                        {{ template.usage_count }} usos
                                    </small>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary" onclick="previewTemplate('{{ template.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-primary">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Search Modal -->
<div class="modal fade" id="advancedSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Búsqueda Avanzada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="advancedSearchForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Buscar en</label>
                            <input type="text" class="form-control" name="query" placeholder="Términos de búsqueda...">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Tipo de archivo</label>
                            <select class="form-select" name="file_type">
                                <option value="">Todos los tipos</option>
                                <option value="pdf">PDF</option>
                                <option value="doc">Documentos Word</option>
                                <option value="xls">Hojas de Excel</option>
                                <option value="ppt">Presentaciones</option>
                                <option value="img">Imágenes</option>
                                <option value="video">Videos</option>
                                <option value="audio">Audio</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Tamaño de archivo</label>
                            <select class="form-select" name="file_size">
                                <option value="">Cualquier tamaño</option>
                                <option value="small">Menos de 1 MB</option>
                                <option value="medium">1 MB - 10 MB</option>
                                <option value="large">10 MB - 100 MB</option>
                                <option value="xlarge">Más de 100 MB</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Fecha de creación</label>
                            <select class="form-select" name="date_range">
                                <option value="">Cualquier fecha</option>
                                <option value="today">Hoy</option>
                                <option value="week">Esta semana</option>
                                <option value="month">Este mes</option>
                                <option value="quarter">Este trimestre</option>
                                <option value="year">Este año</option>
                                <option value="custom">Rango personalizado</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Estado del documento</label>
                            <select class="form-select" name="status">
                                <option value="">Cualquier estado</option>
                                <option value="draft">Borrador</option>
                                <option value="review">En revisión</option>
                                <option value="approved">Aprobado</option>
                                <option value="rejected">Rechazado</option>
                                <option value="archived">Archivado</option>
                            </select>
                        </div>
                        
                        <div class="col-12" id="customDateRange" style="display: none;">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">Desde</label>
                                    <input type="date" class="form-control" name="date_from">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Hasta</label>
                                    <input type="date" class="form-control" name="date_to">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Etiquetas</label>
                            <input type="text" class="form-control" name="tags" placeholder="Etiquetas separadas por comas...">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Compartido por</label>
                            <select class="form-select" name="shared_by">
                                <option value="">Cualquier persona</option>
                                <option value="me">Yo</option>
                                <option value="mentors">Mis mentores</option>
                                <option value="peers">Compañeros</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Proyecto asociado</label>
                            <select class="form-select" name="project">
                                <option value="">Cualquier proyecto</option>
                                {% for project in user_projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearAdvancedSearch()">
                    <i class="fas fa-eraser me-1"></i>
                    Limpiar
                </button>
                <button type="button" class="btn btn-primary" onclick="performAdvancedSearch()">
                    <i class="fas fa-search me-1"></i>
                    Buscar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/dropzone/dropzone.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/pdf-viewer/pdf-viewer.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/sortable/sortable.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/lightbox/lightbox.js') }}"></script>
<script src="{{ url_for('static', filename='dist/js/documents.js') }}"></script>
<script>
// Global variables
let currentFolder = 'all';
let selectedDocuments = new Set();
let bulkSelectMode = false;
let documentViewer = null;
let currentDocument = null;

// Document manager configuration
const documentManager = {
    endpoints: {
        list: "{{ url_for('api.v1.documents.list') }}",
        upload: "{{ url_for('api.v1.documents.upload') }}",
        view: "{{ url_for('api.v1.documents.view', id='') }}",
        download: "{{ url_for('api.v1.documents.download', id='') }}",
        delete: "{{ url_for('api.v1.documents.delete', id='') }}",
        share: "{{ url_for('api.v1.documents.share') }}",
        createFolder: "{{ url_for('api.v1.documents.create_folder') }}",
        comments: "{{ url_for('api.v1.documents.comments', id='') }}",
        versions: "{{ url_for('api.v1.documents.versions', id='') }}",
        search: "{{ url_for('api.v1.documents.search') }}",
        bulkDelete: "{{ url_for('api.v1.documents.bulk_delete') }}",
        bulkDownload: "{{ url_for('api.v1.documents.bulk_download') }}",
        syncCloud: "{{ url_for('api.v1.documents.sync_cloud') }}"
    },
    csrfToken: "{{ csrf_token() }}",
    maxFileSize: 100 * 1024 * 1024, // 100MB
    allowedTypes: [
        'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'image/jpeg', 'image/png', 'image/gif', 'image/svg+xml',
        'video/mp4', 'video/avi', 'video/quicktime',
        'audio/mpeg', 'audio/wav', 'audio/flac',
        'application/zip', 'application/x-rar-compressed'
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize all components
    initializeDocumentManager();
    initializeDragAndDrop();
    initializeSearch();
    initializeFilters();
    initializeFileUpload();
    initializeWebSocket();
    initializeKeyboardShortcuts();
    
    // Load initial documents
    loadDocuments();
});

function initializeDocumentManager() {
    // Folder navigation
    document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelector('.folder-item.active')?.classList.remove('active');
            this.classList.add('active');
            
            const folderId = this.dataset.folderId || this.dataset.filter;
            navigateToFolder(folderId);
        });
    });

    // View toggle
    document.querySelectorAll('[data-view]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelector('[data-view].active')?.classList.remove('active');
            this.classList.add('active');
            toggleView(this.dataset.view);
        });
    });

    // Sort and filter handlers
    document.getElementById('sortBy').addEventListener('change', loadDocuments);
    document.getElementById('statusFilter').addEventListener('change', loadDocuments);

    // File type filters
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            document.querySelector('.filter-chip.active')?.classList.remove('active');
            this.classList.add('active');
            loadDocuments();
        });
    });
}

function initializeDragAndDrop() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight drop area
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
    });

    // Handle dropped files
    uploadZone.addEventListener('drop', handleDrop, false);
    uploadZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        const validFiles = Array.from(files).filter(file => {
            if (file.size > documentManager.maxFileSize) {
                showNotification(`El archivo ${file.name} es demasiado grande (máximo 100MB)`, 'warning');
                return false;
            }
            return true;
        });

        if (validFiles.length === 0) return;

        displaySelectedFiles(validFiles);
        updateUploadButton(validFiles.length);
    }

    function displaySelectedFiles(files) {
        const fileList = document.getElementById('fileList');
        const selectedFiles = document.getElementById('selectedFiles');
        
        fileList.style.display = 'block';
        selectedFiles.innerHTML = '';

        files.forEach((file, index) => {
            const fileItem = createFileItem(file, index);
            selectedFiles.appendChild(fileItem);
        });
    }

    function createFileItem(file, index) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item d-flex justify-content-between align-items-center p-3 border rounded mb-2 bg-white';
        fileItem.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="file-icon me-3">
                    ${getFileIcon(file.type)}
                </div>
                <div>
                    <div class="fw-bold">${file.name}</div>
                    <small class="text-muted">${formatFileSize(file.size)} • ${file.type || 'Tipo desconocido'}</small>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        return fileItem;
    }
}

function initializeSearch() {
    const searchInput = document.getElementById('documentSearch');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadDocuments();
        }, 300);
    });

    // Advanced search modal handler
    document.querySelector('select[name="date_range"]')?.addEventListener('change', function() {
        const customDateRange = document.getElementById('customDateRange');
        customDateRange.style.display = this.value === 'custom' ? 'block' : 'none';
    });
}

function initializeFilters() {
    // Template category filters
    document.querySelectorAll('[data-category]').forEach(filter => {
        filter.addEventListener('click', function() {
            document.querySelector('[data-category].active')?.classList.remove('active');
            this.classList.add('active');
            filterTemplates(this.dataset.category);
        });
    });
}

function initializeFileUpload() {
    // Upload form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFiles();
    });

    // Create folder form submission
    document.getElementById('createFolderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createFolder();
    });

    // Share form submission
    document.getElementById('shareForm').addEventListener('submit', function(e) {
        e.preventDefault();
        shareDocument();
    });

    // Add comment form submission
    document.getElementById('addCommentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addComment();
    });
}

function initializeWebSocket() {
    if (typeof io !== 'undefined') {
        const socket = io('/documents');
        
        socket.on('document_updated', function(data) {
            updateDocumentCard(data);
            showNotification(`Documento actualizado: ${data.title}`, 'info');
        });
        
        socket.on('document_shared', function(data) {
            showNotification(`Nuevo documento compartido: ${data.title}`, 'success');
            loadDocuments();
        });
        
        socket.on('comment_added', function(data) {
            if (currentDocument && currentDocument.id === data.document_id) {
                loadComments(data.document_id);
            }
            showNotification(`Nuevo comentario en: ${data.document_title}`, 'info');
        });

        socket.on('sync_completed', function(data) {
            showNotification('Sincronización con la nube completada', 'success');
            loadDocuments();
        });
    }
}

function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Only handle shortcuts when not in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        // Ctrl/Cmd + U - Upload files
        if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
            e.preventDefault();
            document.querySelector('[data-bs-target="#uploadModal"]').click();
        }
        
        // Ctrl/Cmd + F - Focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.getElementById('documentSearch').focus();
        }
        
        // Ctrl/Cmd + A - Select all (in bulk mode)
        if ((e.ctrlKey || e.metaKey) && e.key === 'a' && bulkSelectMode) {
            e.preventDefault();
            selectAllDocuments();
        }
        
        // Delete key - Delete selected documents
        if (e.key === 'Delete' && selectedDocuments.size > 0) {
            bulkDelete();
        }
        
        // Escape - Close modals or exit bulk mode
        if (e.key === 'Escape') {
            if (bulkSelectMode) {
                toggleBulkSelect();
            }
        }
    });
}

// Document Management Functions
function navigateToFolder(folderId) {
    currentFolder = folderId;
    updateBreadcrumb(folderId);
    loadDocuments();
}

function loadDocuments() {
    showLoadingState(true);
    
    const params = new URLSearchParams({
        folder: currentFolder,
        search: document.getElementById('documentSearch').value,
        sort: document.getElementById('sortBy').value,
        status: document.getElementById('statusFilter').value,
        file_type: document.querySelector('.filter-chip.active').dataset.type
    });

    fetch(`${documentManager.endpoints.list}?${params}`)
        .then(response => {
            if (!response.ok) throw new Error('Failed to load documents');
            return response.json();
        })
        .then(data => {
            updateDocumentGrid(data.documents);
            updateStats(data.stats);
            updatePagination(data.pagination);
        })
        .catch(error => {
            console.error('Error loading documents:', error);
            showNotification('Error al cargar documentos', 'error');
        })
        .finally(() => {
            showLoadingState(false);
        });
}

function updateDocumentGrid(documents) {
    const container = document.getElementById('documentsContainer');
    const grid = document.getElementById('documentGrid');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = createEmptyState();
        return;
    }
    
    grid.innerHTML = '';
    documents.forEach(doc => {
        const cardElement = createDocumentCardElement(doc);
        grid.appendChild(cardElement);
    });
}

function createDocumentCardElement(document) {
    const card = document.createElement('div');
    card.className = 'document-card';
    card.dataset.documentId = document.id;
    card.dataset.fileType = document.file_extension;
    
    card.innerHTML = `
        <!-- Document Header -->
        <div class="document-header">
            <div class="document-status status-${document.status}">
                ${document.status_display}
            </div>
            <div class="document-actions">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-light btn-sm" onclick="viewDocument(${document.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="downloadDocument(${document.id})">
                            <i class="fas fa-download me-2"></i>Descargar
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="shareDocument(${document.id})">
                            <i class="fas fa-share me-2"></i>Compartir
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="editDocument(${document.id})">
                            <i class="fas fa-edit me-2"></i>Editar
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="viewVersions(${document.id})">
                            <i class="fas fa-history me-2"></i>Historial
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="duplicateDocument(${document.id})">
                            <i class="fas fa-copy me-2"></i>Duplicar
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleFavorite(${document.id})">
                            <i class="fas fa-star me-2"></i>${document.is_favorite ? 'Quitar de favoritos' : 'Añadir a favoritos'}
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument(${document.id})">
                            <i class="fas fa-trash me-2"></i>Eliminar
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Selection Checkbox -->
        <div class="document-select" style="display: ${bulkSelectMode ? 'block' : 'none'}">
            <input type="checkbox" class="form-check-input" value="${document.id}" onchange="updateSelectedCount()">
        </div>

        <!-- Document Preview -->
        <div class="document-preview" onclick="viewDocument(${document.id})">
            ${document.has_thumbnail ? 
                `<img src="${document.thumbnail_url}" alt="${document.title}" loading="lazy">` :
                getFileIconHTML(document.file_extension, 'file-icon')
            }
            ${document.is_favorite ? '<i class="fas fa-star position-absolute top-0 end-0 m-3 text-warning"></i>' : ''}
        </div>

        <!-- Document Info -->
        <div class="document-info">
            <h6 class="document-title" title="${document.title}">
                ${document.title.length > 50 ? document.title.substring(0, 50) + '...' : document.title}
            </h6>
            
            <div class="document-meta">
                <span class="document-size">${document.file_size_human}</span>
                <span class="text-muted">v${document.version}</span>
            </div>
            
            ${document.description ? `<div class="document-description">${document.description}</div>` : ''}

            <div class="d-flex justify-content-between align-items-center text-muted small">
                <span>
                    <i class="fas fa-clock me-1"></i>
                    ${document.updated_at_formatted}
                </span>
                ${document.view_count ? `<span><i class="fas fa-eye me-1"></i>${document.view_count}</span>` : ''}
            </div>

            ${document.project ? `
                <div class="mt-2">
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-project-diagram me-1"></i>
                        ${document.project.name}
                    </span>
                </div>
            ` : ''}

            ${document.tags && document.tags.length > 0 ? `
                <div class="document-tags">
                    ${document.tags.slice(0, 3).map(tag => `<span class="tag">${tag.name}</span>`).join('')}
                    ${document.tags.length > 3 ? `<span class="tag">+${document.tags.length - 3}</span>` : ''}
                </div>
            ` : ''}

            ${document.shared_with && document.shared_with.length > 0 ? `
                <div class="sharing-info">
                    <div class="sharing-avatars">
                        ${document.shared_with.slice(0, 4).map(user => 
                            `<img src="${user.avatar_url || '/static/img/default-avatar.png'}" 
                                  alt="${user.full_name}" class="sharing-avatar" title="${user.full_name}">`
                        ).join('')}
                    </div>
                    <small class="text-muted">
                        Compartido con ${document.shared_with.length} ${document.shared_with.length === 1 ? 'persona' : 'personas'}
                    </small>
                </div>
            ` : ''}
        </div>
    `;
    
    return card;
}

function createEmptyState() {
    return `
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-folder-open"></i>
            </div>
            <h3>No hay documentos en esta ubicación</h3>
            <p>Comienza subiendo tu primer documento o creando uno desde una plantilla</p>
            <div class="d-flex gap-3 justify-content-center">
                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir Documento
                </button>
                <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#templatesModal">
                    <i class="fas fa-file-contract me-2"></i>
                    Ver Plantillas
                </button>
            </div>
        </div>
    `;
}

// Document Actions
function viewDocument(documentId) {
    fetch(`${documentManager.endpoints.view}${documentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentDocument = data.document;
                openDocumentViewer(data);
            } else {
                showNotification('Error al cargar el documento', 'error');
            }
        })
        .catch(error => {
            console.error('Error viewing document:', error);
            showNotification('Error al cargar el documento', 'error');
        });
}

function openDocumentViewer(documentData) {
    // Update viewer title and info
    document.getElementById('viewerTitle').innerHTML = `
        <i class="fas fa-file me-2"></i>
        ${documentData.document.title}
    `;
    
    document.getElementById('currentDocumentInfo').textContent = 
        `${documentData.document.title} - ${documentData.document.file_size_human}`;
    
    // Load document content
    document.getElementById('documentViewer').innerHTML = documentData.viewer_html;
    
    // Load document information
    document.getElementById('documentInfo').innerHTML = documentData.info_html;
    
    // Load comments and versions
    loadComments(documentData.document.id);
    loadVersions(documentData.document.id);
    loadSharingInfo(documentData.document.id);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
    modal.show();
}

function downloadDocument(documentId) {
    const link = document.createElement('a');
    link.href = `${documentManager.endpoints.download}${documentId}`;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Descarga iniciada', 'success');
}

function shareDocument(documentId) {
    document.getElementById('shareDocumentId').value = documentId;
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function editDocument(documentId) {
    // Open document in external editor or redirect to edit page
    window.open(`{{ url_for('entrepreneur.document_edit', id='') }}${documentId}`, '_blank');
}

function deleteDocument(documentId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este documento? Esta acción no se puede deshacer.')) {
        return;
    }

    fetch(`${documentManager.endpoints.delete}${documentId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-document-id="${documentId}"]`)?.remove();
            showNotification('Documento eliminado exitosamente', 'success');
            updateStats(data.stats);
        } else {
            showNotification(data.message || 'Error al eliminar documento', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting document:', error);
        showNotification('Error al eliminar documento', 'error');
    });
}

function duplicateDocument(documentId) {
    fetch(`${documentManager.endpoints.view}${documentId}/duplicate`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDocuments();
            showNotification('Documento duplicado exitosamente', 'success');
        } else {
            showNotification('Error al duplicar documento', 'error');
        }
    });
}

function toggleFavorite(documentId) {
    fetch(`${documentManager.endpoints.view}${documentId}/favorite`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDocuments(); // Refresh to show updated favorite status
            showNotification(data.is_favorite ? 'Añadido a favoritos' : 'Quitado de favoritos', 'success');
        }
    });
}

// Upload Functions
function uploadFiles() {
    const form = document.getElementById('uploadForm');
    const formData = new FormData(form);
    const progressBar = document.querySelector('#uploadProgress .progress-bar');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBtn = document.getElementById('uploadBtn');
    
    uploadProgress.style.display = 'block';
    uploadBtn.disabled = true;
    
    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.style.width = percentComplete + '%';
            document.getElementById('uploadStatusText').textContent = 
                `Subiendo... ${Math.round(percentComplete)}%`;
        }
    });
    
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                loadDocuments();
                showNotification(`${data.uploaded_count} documentos subidos exitosamente`, 'success');
                form.reset();
                resetUploadForm();
            } else {
                showNotification('Error al subir documentos: ' + data.message, 'error');
            }
        } else {
            showNotification('Error al subir documentos', 'error');
        }
    });
    
    xhr.addEventListener('error', function() {
        showNotification('Error de conexión al subir documentos', 'error');
    });
    
    xhr.addEventListener('loadend', function() {
        uploadProgress.style.display = 'none';
        uploadBtn.disabled = false;
        progressBar.style.width = '0%';
    });
    
    xhr.open('POST', documentManager.endpoints.upload);
    xhr.setRequestHeader('X-CSRFToken', documentManager.csrfToken);
    xhr.send(formData);
}

function resetUploadForm() {
    document.getElementById('fileList').style.display = 'none';
    document.getElementById('selectedFiles').innerHTML = '';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('fileCount').textContent = '0';
}

function createFolder() {
    const form = document.getElementById('createFolderForm');
    const formData = new FormData(form);

    fetch(documentManager.endpoints.createFolder, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createFolderModal')).hide();
            location.reload(); // Refresh to show new folder in sidebar
            showNotification('Carpeta creada exitosamente', 'success');
        } else {
            showNotification('Error al crear carpeta: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating folder:', error);
        showNotification('Error al crear carpeta', 'error');
    });
}

// Bulk Operations
function toggleBulkSelect() {
    bulkSelectMode = !bulkSelectMode;
    const selectElements = document.querySelectorAll('.document-select');
    const bulkActions = document.getElementById('bulkActions');
    const toggleBtn = document.querySelector('[onclick="toggleBulkSelect()"]');

    selectElements.forEach(el => {
        el.style.display = bulkSelectMode ? 'block' : 'none';
    });

    if (bulkSelectMode) {
        bulkActions.classList.add('show');
        toggleBtn.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar';
        toggleBtn.classList.remove('btn-outline-primary');
        toggleBtn.classList.add('btn-warning');
    } else {
        bulkActions.classList.remove('show');
        toggleBtn.innerHTML = '<i class="fas fa-check-square me-1"></i>Seleccionar';
        toggleBtn.classList.remove('btn-warning');
        toggleBtn.classList.add('btn-outline-primary');
        selectedDocuments.clear();
        document.querySelectorAll('.document-select input').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.querySelectorAll('.document-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    
    updateSelectedCount();
}

function updateSelectedCount() {
    selectedDocuments.clear();
    document.querySelectorAll('.document-select input:checked').forEach(checkbox => {
        selectedDocuments.add(checkbox.value);
        checkbox.closest('.document-card').classList.add('selected');
    });
    
    document.querySelectorAll('.document-select input:not(:checked)').forEach(checkbox => {
        checkbox.closest('.document-card').classList.remove('selected');
    });
    
    document.getElementById('selectedCount').textContent = 
        `${selectedDocuments.size} documentos seleccionados`;
}

function selectAllDocuments() {
    document.querySelectorAll('.document-select input').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function bulkDownload() {
    if (selectedDocuments.size === 0) {
        showNotification('Selecciona al menos un documento', 'warning');
        return;
    }

    const params = new URLSearchParams();
    selectedDocuments.forEach(id => params.append('ids', id));
    
    const link = document.createElement('a');
    link.href = `${documentManager.endpoints.bulkDownload}?${params}`;
    link.download = 'documentos.zip';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`Descargando ${selectedDocuments.size} documentos...`, 'info');
}

function bulkShare() {
    if (selectedDocuments.size === 0) {
        showNotification('Selecciona al menos un documento', 'warning');
        return;
    }
    
    // For bulk sharing, we could open a special modal or handle it differently
    showNotification('Función de compartir en lote en desarrollo', 'info');
}

function bulkMove() {
    if (selectedDocuments.size === 0) {
        showNotification('Selecciona al menos un documento', 'warning');
        return;
    }
    
    // Implementation for bulk move to folder
    showNotification('Función de mover en lote en desarrollo', 'info');
}

function bulkArchive() {
    if (selectedDocuments.size === 0) {
        showNotification('Selecciona al menos un documento', 'warning');
        return;
    }
    
    if (!confirm(`¿Estás seguro de que quieres archivar ${selectedDocuments.size} documentos?`)) {
        return;
    }
    
    fetch(`${documentManager.endpoints.view}bulk/archive`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': documentManager.csrfToken
        },
        body: JSON.stringify({
            document_ids: Array.from(selectedDocuments)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDocuments();
            toggleBulkSelect();
            showNotification(`${data.archived_count} documentos archivados`, 'success');
        } else {
            showNotification('Error al archivar documentos', 'error');
        }
    });
}

function bulkDelete() {
    if (selectedDocuments.size === 0) {
        showNotification('Selecciona al menos un documento', 'warning');
        return;
    }
    
    if (!confirm(`¿Estás seguro de que quieres eliminar ${selectedDocuments.size} documentos? Esta acción no se puede deshacer.`)) {
        return;
    }

    fetch(documentManager.endpoints.bulkDelete, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': documentManager.csrfToken
        },
        body: JSON.stringify({
            document_ids: Array.from(selectedDocuments)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDocuments();
            toggleBulkSelect();
            showNotification(`${data.deleted_count} documentos eliminados`, 'success');
        } else {
            showNotification('Error al eliminar documentos', 'error');
        }
    });
}

// Document Viewer Functions
function loadComments(documentId) {
    fetch(`${documentManager.endpoints.comments}${documentId}`)
        .then(response => response.json())
        .then(data => {
            const commentThread = document.getElementById('commentThread');
            const commentCount = document.getElementById('commentCount');
            
            commentCount.textContent = data.comments.length;
            
            if (data.comments.length === 0) {
                commentThread.innerHTML = '<div class="text-center p-3 text-muted">No hay comentarios aún</div>';
                return;
            }
            
            commentThread.innerHTML = data.comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-author">
                        <img src="${comment.author.avatar_url || '/static/img/default-avatar.png'}" 
                             alt="${comment.author.full_name}">
                        ${comment.author.full_name}
                        <span class="comment-time">${comment.created_at_formatted}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                </div>
            `).join('');
        });
}

function loadVersions(documentId) {
    fetch(`${documentManager.endpoints.versions}${documentId}`)
        .then(response => response.json())
        .then(data => {
            const versionTimeline = document.getElementById('versionTimeline');
            
            if (data.versions.length === 0) {
                versionTimeline.innerHTML = '<div class="text-center p-3 text-muted">No hay versiones disponibles</div>';
                return;
            }
            
            versionTimeline.innerHTML = data.versions.map((version, index) => `
                <div class="version-item ${index === 0 ? 'current' : ''}">
                    ${index === 0 ? '<div class="version-badge"></div>' : ''}
                    <div class="version-info">
                        <div class="version-number">Versión ${version.version}</div>
                        <div class="version-date">${version.created_at_formatted}</div>
                    </div>
                    <div class="version-changes">${version.changes || 'Sin descripción de cambios'}</div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewVersion(${version.id})">
                            Ver esta versión
                        </button>
                        ${index !== 0 ? `
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="restoreVersion(${version.id})">
                                Restaurar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        });
}

function loadSharingInfo(documentId) {
    fetch(`${documentManager.endpoints.view}${documentId}/sharing`)
        .then(response => response.json())
        .then(data => {
            const sharingInfo = document.getElementById('sharingInfo');
            
            if (data.shared_with.length === 0) {
                sharingInfo.innerHTML = '<div class="text-center p-3 text-muted">No compartido con nadie</div>';
                return;
            }
            
            sharingInfo.innerHTML = data.shared_with.map(share => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                    <div class="d-flex align-items-center">
                        <img src="${share.user.avatar_url || '/static/img/default-avatar.png'}" 
                             alt="${share.user.full_name}" 
                             class="rounded-circle me-2" 
                             style="width: 32px; height: 32px;">
                        <div>
                            <div class="fw-bold small">${share.user.full_name}</div>
                            <div class="text-muted tiny">${share.permission_level}</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="revokeAccess(${documentId}, ${share.user.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        });
}

function addComment() {
    const form = document.getElementById('addCommentForm');
    const formData = new FormData(form);
    formData.append('document_id', currentDocument.id);

    fetch(`${documentManager.endpoints.comments}${currentDocument.id}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            form.reset();
            loadComments(currentDocument.id);
            showNotification('Comentario añadido', 'success');
        } else {
            showNotification('Error al añadir comentario', 'error');
        }
    });
}

// Advanced Search Functions
function advancedSearch() {
    const modal = new bootstrap.Modal(document.getElementById('advancedSearchModal'));
    modal.show();
}

function performAdvancedSearch() {
    const form = document.getElementById('advancedSearchForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);

    fetch(`${documentManager.endpoints.search}?${params}`)
        .then(response => response.json())
        .then(data => {
            updateDocumentGrid(data.documents);
            bootstrap.Modal.getInstance(document.getElementById('advancedSearchModal')).hide();
            showNotification(`Encontrados ${data.documents.length} documentos`, 'info');
        });
}

function clearAdvancedSearch() {
    document.getElementById('advancedSearchForm').reset();
    document.getElementById('customDateRange').style.display = 'none';
}

// Template Functions
function useTemplate(templateId) {
    window.open(`{{ url_for('entrepreneur.create_from_template', id='') }}${templateId}`, '_blank');
    bootstrap.Modal.getInstance(document.getElementById('templatesModal')).hide();
}

function previewTemplate(templateId) {
    window.open(`{{ url_for('entrepreneur.template_preview', id='') }}${templateId}`, '_blank');
}

function filterTemplates(category) {
    const templates = document.querySelectorAll('.template-item');
    templates.forEach(template => {
        if (category === 'all' || template.dataset.category === category) {
            template.style.display = 'block';
        } else {
            template.style.display = 'none';
        }
    });
}

// Cloud Sync Functions
function syncWithCloud() {
    showNotification('Iniciando sincronización con la nube...', 'info');
    
    fetch(documentManager.endpoints.syncCloud, {
        method: 'POST',
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDocuments();
            showNotification('Sincronización completada exitosamente', 'success');
        } else {
            showNotification('Error en la sincronización: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Sync error:', error);
        showNotification('Error de conexión durante la sincronización', 'error');
    });
}

// Quick Action Functions
function createFromTemplate(templateType) {
    const templates = {
        business_plan: 'plan-de-negocio',
        financial_projection: 'proyeccion-financiera',
        pitch_deck: 'pitch-deck'
    };
    
    const templateId = templates[templateType];
    if (templateId) {
        useTemplate(templateId);
    } else {
        showNotification('Plantilla no disponible', 'warning');
    }
}

function scanDocument() {
    // Implementation for document scanning
    showNotification('Función de escaneo de documentos en desarrollo', 'info');
}

// Utility Functions
function updateBreadcrumb(folderId) {
    const breadcrumb = document.getElementById('folderBreadcrumb');
    
    // This would typically fetch the folder path from the server
    // For now, we'll update based on the current folder
    if (folderId === 'all') {
        breadcrumb.innerHTML = `
            <li class="breadcrumb-item active">
                <i class="fas fa-home me-1"></i>
                Inicio
            </li>
        `;
    } else {
        // Add logic to build breadcrumb path
        breadcrumb.innerHTML += `
            <li class="breadcrumb-item active">${folderId}</li>
        `;
    }
}

function updateStats(stats) {
    if (!stats) return;
    
    const statCards = document.querySelectorAll('.stat-card .stat-number');
    if (statCards.length >= 4) {
        statCards[0].textContent = stats.total || 0;
        statCards[1].textContent = (stats.total_size_mb || 0).toFixed(1);
        statCards[2].textContent = stats.shared || 0;
        statCards[3].textContent = stats.recent || 0;
    }
}

function updatePagination(pagination) {
    // Implementation for pagination update
    if (pagination && pagination.pages > 1) {
        // Show pagination controls
    }
}

function toggleView(view) {
    const grid = document.getElementById('documentGrid');
    if (view === 'list') {
        grid.classList.add('list-view');
    } else {
        grid.classList.remove('list-view');
    }
}

function showLoadingState(show) {
    const loadingState = document.getElementById('loadingState');
    const documentsContainer = document.getElementById('documentsContainer');
    
    if (show) {
        loadingState.style.display = 'flex';
        documentsContainer.style.opacity = '0.5';
    } else {
        loadingState.style.display = 'none';
        documentsContainer.style.opacity = '1';
    }
}

function updateUploadButton(fileCount) {
    const uploadBtn = document.getElementById('uploadBtn');
    const fileCountSpan = document.getElementById('fileCount');
    
    uploadBtn.disabled = fileCount === 0;
    fileCountSpan.textContent = fileCount;
}

function removeFile(index) {
    // Implementation to remove file from upload list
    const fileItems = document.querySelectorAll('.file-item');
    if (fileItems[index]) {
        fileItems[index].remove();
        updateUploadButton(fileItems.length - 1);
    }
}

function getFileIcon(fileType) {
    const iconMap = {
        'application/pdf': '<i class="fas fa-file-pdf text-danger" style="font-size: 2rem;"></i>',
        'application/msword': '<i class="fas fa-file-word text-primary" style="font-size: 2rem;"></i>',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '<i class="fas fa-file-word text-primary" style="font-size: 2rem;"></i>',
        'application/vnd.ms-excel': '<i class="fas fa-file-excel text-success" style="font-size: 2rem;"></i>',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '<i class="fas fa-file-excel text-success" style="font-size: 2rem;"></i>',
        'application/vnd.ms-powerpoint': '<i class="fas fa-file-powerpoint text-warning" style="font-size: 2rem;"></i>',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation': '<i class="fas fa-file-powerpoint text-warning" style="font-size: 2rem;"></i>',
        'image/jpeg': '<i class="fas fa-file-image text-info" style="font-size: 2rem;"></i>',
        'image/png': '<i class="fas fa-file-image text-info" style="font-size: 2rem;"></i>',
        'image/gif': '<i class="fas fa-file-image text-info" style="font-size: 2rem;"></i>',
        'video/mp4': '<i class="fas fa-file-video text-danger" style="font-size: 2rem;"></i>',
        'audio/mpeg': '<i class="fas fa-file-audio text-warning" style="font-size: 2rem;"></i>',
        'application/zip': '<i class="fas fa-file-archive text-secondary" style="font-size: 2rem;"></i>'
    };
    
    return iconMap[fileType] || '<i class="fas fa-file text-muted" style="font-size: 2rem;"></i>';
}

function getFileIconHTML(extension, className = '') {
    const ext = extension.toLowerCase();
    let iconClass = 'fas fa-file';
    let colorClass = 'text-muted';
    
    if (ext === 'pdf') {
        iconClass = 'fas fa-file-pdf';
        colorClass = 'text-danger';
    } else if (['doc', 'docx'].includes(ext)) {
        iconClass = 'fas fa-file-word';
        colorClass = 'text-primary';
    } else if (['xls', 'xlsx'].includes(ext)) {
        iconClass = 'fas fa-file-excel';
        colorClass = 'text-success';
    } else if (['ppt', 'pptx'].includes(ext)) {
        iconClass = 'fas fa-file-powerpoint';
        colorClass = 'text-warning';
    } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
        iconClass = 'fas fa-file-image';
        colorClass = 'text-info';
    } else if (['mp4', 'avi', 'mov'].includes(ext)) {
        iconClass = 'fas fa-file-video';
        colorClass = 'text-danger';
    } else if (['mp3', 'wav', 'flac'].includes(ext)) {
        iconClass = 'fas fa-file-audio';
        colorClass = 'text-warning';
    } else if (['zip', 'rar', '7z'].includes(ext)) {
        iconClass = 'fas fa-file-archive';
        colorClass = 'text-secondary';
    }
    
    return `<i class="${iconClass} ${className} ${colorClass}"></i>`;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showNotification(message, type = 'info') {
    const alertTypes = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertTypes[type]} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Document Viewer Controls
function zoomIn() {
    // Implementation for zoom in
}

function zoomOut() {
    // Implementation for zoom out
}

function resetZoom() {
    // Implementation for reset zoom
}

function previousPage() {
    // Implementation for previous page
}

function nextPage() {
    // Implementation for next page
}

function downloadCurrentDocument() {
    if (currentDocument) {
        downloadDocument(currentDocument.id);
    }
}

function printCurrentDocument() {
    window.print();
}

function shareCurrentDocument() {
    if (currentDocument) {
        shareDocument(currentDocument.id);
    }
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Share Modal Functions
function generatePublicLink() {
    const documentId = document.getElementById('shareDocumentId').value;
    fetch(`${documentManager.endpoints.view}${documentId}/public-link`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': documentManager.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('publicLink').value = data.public_link;
        }
    });
}

function copyPublicLink() {
    const linkInput = document.getElementById('publicLink');
    linkInput.select();
    document.execCommand('copy');
    showNotification('Enlace copiado al portapapeles', 'success');
}

function revokeAccess(documentId, userId) {
    if (!confirm('¿Estás seguro de que quieres revocar el acceso a este usuario?')) {
        return;
    }
    
    fetch(`${documentManager.endpoints.view}${documentId}/revoke-access`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': documentManager.csrfToken
        },
        body: JSON.stringify({ user_id: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadSharingInfo(documentId);
            showNotification('Acceso revocado', 'success');
        }
    });
}

// Global function assignments for onclick handlers
window.viewDocument = viewDocument;
window.downloadDocument = downloadDocument;
window.shareDocument = shareDocument;
window.editDocument = editDocument;
window.deleteDocument = deleteDocument;
window.duplicateDocument = duplicateDocument;
window.toggleFavorite = toggleFavorite;
window.navigateToFolder = navigateToFolder;
window.toggleBulkSelect = toggleBulkSelect;
window.updateSelectedCount = updateSelectedCount;
window.bulkDownload = bulkDownload;
window.bulkShare = bulkShare;
window.bulkMove = bulkMove;
window.bulkArchive = bulkArchive;
window.bulkDelete = bulkDelete;
window.syncWithCloud = syncWithCloud;
window.createFromTemplate = createFromTemplate;
window.scanDocument = scanDocument;
window.useTemplate = useTemplate;
window.previewTemplate = previewTemplate;
window.advancedSearch = advancedSearch;
window.performAdvancedSearch = performAdvancedSearch;
window.clearAdvancedSearch = clearAdvancedSearch;
window.removeFile = removeFile;
window.generatePublicLink = generatePublicLink;
window.copyPublicLink = copyPublicLink;
window.revokeAccess = revokeAccess;
window.addComment = addComment;
window.zoomIn = zoomIn;
window.zoomOut = zoomOut;
window.resetZoom = resetZoom;
window.previousPage = previousPage;
window.nextPage = nextPage;
window.downloadCurrentDocument = downloadCurrentDocument;
window.printCurrentDocument = printCurrentDocument;
window.shareCurrentDocument = shareCurrentDocument;
window.toggleFullscreen = toggleFullscreen;
</script>
{% endblock %}