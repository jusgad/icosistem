<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mensajes - Dashboard Emprendedor</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --border-radius: 12px;
            --sidebar-width: 280px;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .messages-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .messages-container {
            display: flex;
            height: calc(100vh - 140px);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            margin: 0 auto;
            overflow: hidden;
        }

        .messages-sidebar {
            width: var(--sidebar-width);
            border-right: 2px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .messages-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            background: white;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            margin: 0;
        }

        .nav-link {
            color: var(--dark-text);
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--secondary-color);
            color: white;
        }

        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
            border-bottom: 2px solid #e9ecef;
        }

        .message-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .message-item:hover {
            background: #f8f9fa;
        }

        .message-item.unread {
            background: #e3f2fd;
            border-left: 4px solid var(--secondary-color);
        }

        .message-item.selected {
            background: var(--secondary-color);
            color: white;
        }

        .message-item.selected .text-muted {
            color: #ddd !important;
        }

        .message-preview {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-info {
            flex: 1;
            min-width: 0;
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-subject {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-snippet {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            white-space: nowrap;
        }

        .message-flags {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .message-flag {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            font-weight: 500;
        }

        .flag-priority {
            background: #fee;
            color: var(--danger-color);
        }

        .flag-attachment {
            background: #f0f8ff;
            color: var(--secondary-color);
        }

        .message-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .message-toolbar {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 1rem;
        }

        .message-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .message-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .message-body {
            line-height: 1.6;
            color: var(--dark-text);
        }

        .compose-modal .modal-dialog {
            max-width: 80%;
            height: 80vh;
        }

        .compose-modal .modal-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .compose-modal .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .compose-form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .compose-editor {
            flex: 1;
            margin-top: 1rem;
        }

        .quill-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .quill-editor .ql-container {
            flex: 1;
            font-size: 14px;
        }

        .attachment-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .attachment-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .attachment-remove {
            color: var(--danger-color);
            cursor: pointer;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            border-radius: 25px;
            padding-left: 2.5rem;
            border: 2px solid #e9ecef;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .stats-cards {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .messages-container {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 140px);
            }

            .messages-sidebar {
                width: 100%;
                order: 2;
                max-height: 300px;
            }

            .messages-main {
                order: 1;
                min-height: 400px;
            }

            .stats-cards {
                flex-direction: column;
            }

            .compose-modal .modal-dialog {
                max-width: 95%;
                height: 90vh;
            }
        }

        .priority-high { color: var(--danger-color); }
        .priority-medium { color: var(--warning-color); }
        .priority-low { color: var(--success-color); }

        .status-sent { color: var(--success-color); }
        .status-draft { color: var(--warning-color); }
        .status-failed { color: var(--danger-color); }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="messages-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-envelope me-3"></i>Centro de Mensajes</h1>
                    <p class="mb-0 mt-2">Gestiona toda tu comunicación empresarial</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-light btn-custom me-2" onclick="refreshMessages()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                    <button class="btn btn-warning btn-custom" onclick="showComposeModal()">
                        <i class="fas fa-pen me-2"></i>Redactar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-3">
        <div class="messages-container">
            <!-- Sidebar -->
            <div class="messages-sidebar">
                <div class="sidebar-header">
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchMessages" placeholder="Buscar mensajes...">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="stats-cards mt-3">
                        <div class="stat-card">
                            <div class="stat-number" id="unreadCount">0</div>
                            <div class="stat-label">No leídos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="todayCount">0</div>
                            <div class="stat-label">Hoy</div>
                        </div>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-folder="inbox" onclick="switchFolder('inbox')">
                                <span><i class="fas fa-inbox"></i>Bandeja de entrada</span>
                                <span class="badge bg-primary rounded-pill" id="inboxCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-folder="sent" onclick="switchFolder('sent')">
                                <span><i class="fas fa-paper-plane"></i>Enviados</span>
                                <span class="badge bg-secondary rounded-pill" id="sentCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-folder="drafts" onclick="switchFolder('drafts')">
                                <span><i class="fas fa-edit"></i>Borradores</span>
                                <span class="badge bg-warning rounded-pill" id="draftsCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-folder="starred" onclick="switchFolder('starred')">
                                <span><i class="fas fa-star"></i>Destacados</span>
                                <span class="badge bg-warning rounded-pill" id="starredCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-folder="important" onclick="switchFolder('important')">
                                <span><i class="fas fa-exclamation"></i>Importantes</span>
                                <span class="badge bg-danger rounded-pill" id="importantCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-folder="trash" onclick="switchFolder('trash')">
                                <span><i class="fas fa-trash"></i>Papelera</span>
                                <span class="badge bg-dark rounded-pill" id="trashCount">0</span>
                            </a>
                        </li>
                    </ul>

                    <hr class="mx-3">
                    
                    <div class="px-3 py-2">
                        <h6 class="text-muted mb-2">Etiquetas</h6>
                        <div class="d-flex flex-wrap gap-1" id="labelsList">
                            <span class="badge bg-info">Clientes</span>
                            <span class="badge bg-success">Proveedores</span>
                            <span class="badge bg-warning">Seguimiento</span>
                            <span class="badge bg-danger">Urgente</span>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="messages-main">
                <!-- Message List -->
                <div class="message-list" id="messageList">
                    <!-- Los mensajes se cargarán aquí dinámicamente -->
                </div>

                <!-- Message View -->
                <div class="message-view" id="messageView">
                    <div class="empty-state">
                        <i class="fas fa-envelope-open"></i>
                        <h5>Selecciona un mensaje</h5>
                        <p>Elige un mensaje de la lista para verlo aquí</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Composición -->
    <div class="modal fade compose-modal" id="composeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-pen me-2"></i>
                        <span id="composeTitle">Nuevo Mensaje</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="saveDraft()">
                            <i class="fas fa-save me-1"></i>Borrador
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="composeForm" class="compose-form">
                        <input type="hidden" id="messageId" name="messageId">
                        <input type="hidden" id="isDraft" name="isDraft" value="false">
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="recipients" class="form-label">Para:</label>
                                <input type="email" class="form-control" id="recipients" name="recipients" 
                                       placeholder="destinatario@ejemplo.com" multiple required>
                            </div>
                            <div class="col-md-4">
                                <label for="priority" class="form-label">Prioridad:</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="low">Baja</option>
                                    <option value="medium" selected>Media</option>
                                    <option value="high">Alta</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="email" class="form-control" id="ccRecipients" name="ccRecipients" 
                                       placeholder="CC (opcional)">
                            </div>
                            <div class="col-md-6">
                                <input type="email" class="form-control" id="bccRecipients" name="bccRecipients" 
                                       placeholder="BCC (opcional)">
                            </div>
                        </div>

                        <div class="mb-3">
                            <input type="text" class="form-control" id="subject" name="subject" 
                                   placeholder="Asunto del mensaje" required>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Mensaje:</label>
                                <div>
                                    <input type="file" class="d-none" id="attachmentInput" multiple 
                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            onclick="document.getElementById('attachmentInput').click()">
                                        <i class="fas fa-paperclip me-1"></i>Adjuntar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="compose-editor">
                                <div id="messageEditor" class="quill-editor"></div>
                            </div>
                        </div>

                        <div class="attachment-list" id="attachmentList"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-primary" onclick="scheduleMessage()">
                        <i class="fas fa-clock me-2"></i>Programar
                    </button>
                    <button type="button" class="btn btn-primary-custom" onclick="sendMessage()">
                        <i class="fas fa-paper-plane me-2"></i>Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Programación -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Programar Envío</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scheduleDate" class="form-label">Fecha:</label>
                        <input type="date" class="form-control" id="scheduleDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleTime" class="form-label">Hora:</label>
                        <input type="time" class="form-control" id="scheduleTime" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="confirmSchedule()">
                        <i class="fas fa-clock me-2"></i>Programar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Quill Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.6/quill.min.js"></script>

    <script>
        // Estado global de la aplicación
        let messages = [];
        let currentFolder = 'inbox';
        let selectedMessageId = null;
        let quillEditor = null;
        let attachments = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            loadMessages();
            setupEventListeners();
            updateStats();
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Búsqueda
            document.getElementById('searchMessages').addEventListener('input', filterMessages);
            
            // Adjuntos
            document.getElementById('attachmentInput').addEventListener('change', handleAttachments);
            
            // Auto-guardado de borradores cada 30 segundos
            setInterval(autoSaveDraft, 30000);
        }

        // Inicializar editor Quill
        function initializeEditor() {
            const toolbarOptions = [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ];

            quillEditor = new Quill('#messageEditor', {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions
                },
                placeholder: 'Escribe tu mensaje aquí...'
            });
        }

        // Cargar mensajes (simulado - en producción vendría de la API)
        function loadMessages() {
            // Datos de ejemplo
            messages = [
                {
                    id: 1,
                    folder: 'inbox',
                    from: 'maria.garcia@cliente.com',
                    to: 'emprendedor@empresa.com',
                    subject: 'Propuesta de colaboración estratégica',
                    body: `<p>Estimado/a,</p>
                           <p>Espero que este mensaje le encuentre bien. Mi nombre es María García y soy directora de desarrollo de negocios en TechSolutions.</p>
                           <p>Nos hemos enterado de su exitosa empresa y estamos muy interesados en explorar oportunidades de colaboración estratégica que puedan beneficiar a ambas partes.</p>
                           <p>¿Estaría disponible para una reunión la próxima semana para discutir esta propuesta en detalle?</p>
                           <p>Quedo a la espera de su respuesta.</p>
                           <p>Saludos cordiales,<br>María García</p>`,
                    priority: 'high',
                    isRead: false,
                    isStarred: false,
                    isImportant: true,
                    hasAttachments: true,
                    attachments: ['propuesta_colaboracion.pdf'],
                    labels: ['Clientes', 'Urgente'],
                    createdAt: '2025-06-10T09:30:00',
                    status: 'received'
                },
                {
                    id: 2,
                    folder: 'inbox',
                    from: 'carlos.rodriguez@proveedor.com',
                    to: 'emprendedor@empresa.com',
                    subject: 'Actualización de precios - Servicios de logística',
                    body: `<p>Estimado cliente,</p>
                           <p>Le escribimos para informarle sobre las actualizaciones en nuestros precios de servicios de logística, efectivas a partir del 1 de julio de 2025.</p>
                           <p>Los nuevos precios reflejan:</p>
                           <ul>
                             <li>Mejoras en la calidad del servicio</li>
                             <li>Nuevas rutas de distribución</li>
                             <li>Tecnología de tracking en tiempo real</li>
                           </ul>
                           <p>Adjunto encontrará la nueva lista de precios detallada.</p>
                           <p>Gracias por su confianza.</p>`,
                    priority: 'medium',
                    isRead: true,
                    isStarred: false,
                    isImportant: false,
                    hasAttachments: true,
                    attachments: ['nueva_lista_precios.xlsx'],
                    labels: ['Proveedores'],
                    createdAt: '2025-06-10T08:15:00',
                    status: 'received'
                },
                {
                    id: 3,
                    folder: 'sent',
                    from: 'emprendedor@empresa.com',
                    to: 'equipo@empresa.com',
                    subject: 'Reunión semanal de equipo - Agenda',
                    body: `<p>Equipo,</p>
                           <p>Adjunto la agenda para nuestra reunión semanal del jueves a las 10:00 AM.</p>
                           <p><strong>Temas a tratar:</strong></p>
                           <ol>
                             <li>Review de objetivos Q2</li>
                             <li>Nuevo proyecto de desarrollo</li>
                             <li>Feedback del cliente ABC</li>
                             <li>Planificación del próximo mes</li>
                           </ol>
                           <p>Por favor, preparen sus actualizaciones de proyecto.</p>
                           <p>¡Nos vemos el jueves!</p>`,
                    priority: 'medium',
                    isRead: true,
                    isStarred: false,
                    isImportant: false,
                    hasAttachments: true,
                    attachments: ['agenda_reunion.docx'],
                    labels: ['Equipo'],
                    createdAt: '2025-06-09T16:45:00',
                    status: 'sent'
                },
                {
                    id: 4,
                    folder: 'drafts',
                    from: 'emprendedor@empresa.com',
                    to: 'inversor@fondo.com',
                    subject: 'Propuesta de inversión - Serie A',
                    body: `<p>Estimado Sr. Inversor,</p>
                           <p>Esperamos que este mensaje le encuentre bien. Nos complace presentarle una emocionante oportunidad de inversión...</p>
                           <p><em>[Borrador incompleto]</em></p>`,
                    priority: 'high',
                    isRead: true,
                    isStarred: true,
                    isImportant: true,
                    hasAttachments: false,
                    attachments: [],
                    labels: ['Inversores'],
                    createdAt: '2025-06-10T10:30:00',
                    status: 'draft'
                }
            ];

            renderMessages();
            updateStats();
        }

        // Renderizar lista de mensajes
        function renderMessages() {
            const messageList = document.getElementById('messageList');
            const filteredMessages = getFilteredMessages();
            
            messageList.innerHTML = '';

            if (filteredMessages.length === 0) {
                messageList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h5>No hay mensajes</h5>
                        <p>No se encontraron mensajes en esta carpeta</p>
                    </div>
                `;
                return;
            }

            filteredMessages.forEach(message => {
                const messageItem = createMessageItem(message);
                messageList.appendChild(messageItem);
            });
        }

        // Crear elemento de mensaje
        function createMessageItem(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item ${!message.isRead ? 'unread' : ''} ${selectedMessageId === message.id ? 'selected' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);
            messageDiv.onclick = () => selectMessage(message.id);

            const senderName = message.folder === 'sent' ? `Para: ${message.to.split('@')[0]}` : message.from.split('@')[0];
            const avatar = senderName.charAt(0).toUpperCase();
            
            messageDiv.innerHTML = `
                <div class="message-preview">
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-info">
                        <div class="message-sender">
                            <span class="${!message.isRead ? 'fw-bold' : ''}">${senderName}</span>
                            <span class="message-time">${formatTime(message.createdAt)}</span>
                        </div>
                        <div class="message-subject ${!message.isRead ? 'fw-bold' : ''}">${message.subject}</div>
                        <div class="message-snippet">${getTextSnippet(message.body)}</div>
                        <div class="message-flags">
                            ${message.priority === 'high' ? '<span class="message-flag flag-priority">Alta prioridad</span>' : ''}
                            ${message.hasAttachments ? '<span class="message-flag flag-attachment"><i class="fas fa-paperclip"></i></span>' : ''}
                            ${message.isStarred ? '<i class="fas fa-star text-warning"></i>' : ''}
                            ${message.isImportant ? '<i class="fas fa-exclamation text-danger"></i>' : ''}
                        </div>
                    </div>
                </div>
            `;

            return messageDiv;
        }

        // Seleccionar mensaje
        function selectMessage(messageId) {
            selectedMessageId = messageId;
            const message = messages.find(m => m.id === messageId);
            
            if (!message) return;

            // Marcar como leído
            if (!message.isRead) {
                message.isRead = true;
                updateStats();
            }

            // Actualizar selección visual
            document.querySelectorAll('.message-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-message-id="${messageId}"]`).classList.add('selected');

            // Renderizar vista del mensaje
            renderMessageView(message);
        }

        // Renderizar vista del mensaje
        function renderMessageView(message) {
            const messageView = document.getElementById('messageView');
            
            messageView.innerHTML = `
                <div class="message-toolbar">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="replyMessage(${message.id})">
                            <i class="fas fa-reply me-1"></i>Responder
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="forwardMessage(${message.id})">
                            <i class="fas fa-share me-1"></i>Reenviar
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="toggleStar(${message.id})">
                            <i class="fas fa-star${message.isStarred ? '' : '-o'} me-1"></i>
                            ${message.isStarred ? 'Quitar estrella' : 'Marcar'}
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="archiveMessage(${message.id})">
                            <i class="fas fa-archive me-1"></i>Archivar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage(${message.id})">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                    </div>
                </div>
                
                <div class="message-content">
                    <div class="message-header">
                        <h4 class="mb-3">${message.subject}</h4>
                        <div class="row">
                            <div class="col-md-8">
                                <p class="mb-1"><strong>De:</strong> ${message.from}</p>
                                <p class="mb-1"><strong>Para:</strong> ${message.to}</p>
                                <p class="mb-1"><strong>Fecha:</strong> ${formatDateTime(message.createdAt)}</p>
                                ${message.priority === 'high' ? '<p class="mb-1"><span class="badge bg-danger">Alta Prioridad</span></p>' : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                ${message.labels.map(label => `<span class="badge bg-info me-1">${label}</span>`).join('')}
                            </div>
                        </div>
                        
                        ${message.hasAttachments ? `
                            <div class="mt-3">
                                <h6><i class="fas fa-paperclip me-2"></i>Adjuntos:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${message.attachments.map(attachment => `
                                        <div class="attachment-item">
                                            <i class="fas fa-file-alt text-primary"></i>
                                            <span>${attachment}</span>
                                            <a href="#" class="text-primary ms-2" onclick="downloadAttachment('${attachment}')">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="message-body">
                        ${message.body}
                    </div>
                </div>
            `;
        }

        // Cambiar carpeta
        function switchFolder(folder) {
            currentFolder = folder;
            selectedMessageId = null;
            
            // Actualizar navegación
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-folder="${folder}"]`).classList.add('active');
            
            // Limpiar vista del mensaje
            document.getElementById('messageView').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-envelope-open"></i>
                    <h5>Selecciona un mensaje</h5>
                    <p>Elige un mensaje de la lista para verlo aquí</p>
                </div>
            `;
            
            renderMessages();
        }

        // Filtrar mensajes
        function getFilteredMessages() {
            const searchTerm = document.getElementById('searchMessages').value.toLowerCase();
            
            return messages.filter(message => {
                const matchesFolder = message.folder === currentFolder || 
                                    (currentFolder === 'starred' && message.isStarred) ||
                                    (currentFolder === 'important' && message.isImportant);
                
                const matchesSearch = !searchTerm || 
                                    message.subject.toLowerCase().includes(searchTerm) ||
                                    message.from.toLowerCase().includes(searchTerm) ||
                                    message.body.toLowerCase().includes(searchTerm);
                
                return matchesFolder && matchesSearch;
            }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        function filterMessages() {
            renderMessages();
        }

        // Actualizar estadísticas
        function updateStats() {
            const unread = messages.filter(m => !m.isRead && m.folder === 'inbox').length;
            const today = messages.filter(m => isToday(m.createdAt)).length;
            
            const folderCounts = {
                inbox: messages.filter(m => m.folder === 'inbox').length,
                sent: messages.filter(m => m.folder === 'sent').length,
                drafts: messages.filter(m => m.folder === 'drafts').length,
                starred: messages.filter(m => m.isStarred).length,
                important: messages.filter(m => m.isImportant).length,
                trash: messages.filter(m => m.folder === 'trash').length
            };

            document.getElementById('unreadCount').textContent = unread;
            document.getElementById('todayCount').textContent = today;
            
            Object.keys(folderCounts).forEach(folder => {
                const element = document.getElementById(`${folder}Count`);
                if (element) {
                    element.textContent = folderCounts[folder];
                    element.style.display = folderCounts[folder] > 0 ? 'inline' : 'none';
                }
            });
        }

        // Modal de composición
        function showComposeModal() {
            document.getElementById('composeTitle').textContent = 'Nuevo Mensaje';
            document.getElementById('composeForm').reset();
            document.getElementById('messageId').value = '';
            document.getElementById('isDraft').value = 'false';
            quillEditor.setContents([]);
            attachments = [];
            updateAttachmentList();
            
            const modal = new bootstrap.Modal(document.getElementById('composeModal'));
            modal.show();
        }

        function replyMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;

            document.getElementById('composeTitle').textContent = 'Responder Mensaje';
            document.getElementById('recipients').value = message.from;
            document.getElementById('subject').value = `Re: ${message.subject}`;
            
            const originalMessage = `
                <br><br>
                <div style="border-left: 3px solid #ccc; padding-left: 15px; margin: 15px 0;">
                    <p><strong>De:</strong> ${message.from}<br>
                    <strong>Fecha:</strong> ${formatDateTime(message.createdAt)}<br>
                    <strong>Asunto:</strong> ${message.subject}</p>
                    ${message.body}
                </div>
            `;
            
            quillEditor.clipboard.dangerouslyPasteHTML(originalMessage);
            quillEditor.setSelection(0, 0);
            
            const modal = new bootstrap.Modal(document.getElementById('composeModal'));
            modal.show();
        }

        function forwardMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;

            document.getElementById('composeTitle').textContent = 'Reenviar Mensaje';
            document.getElementById('subject').value = `Fwd: ${message.subject}`;
            
            const forwardedMessage = `
                <p>---------- Mensaje reenviado ----------</p>
                <p><strong>De:</strong> ${message.from}<br>
                <strong>Para:</strong> ${message.to}<br>
                <strong>Fecha:</strong> ${formatDateTime(message.createdAt)}<br>
                <strong>Asunto:</strong> ${message.subject}</p>
                <br>
                ${message.body}
            `;
            
            quillEditor.clipboard.dangerouslyPasteHTML(forwardedMessage);
            
            const modal = new bootstrap.Modal(document.getElementById('composeModal'));
            modal.show();
        }

        // Envío de mensajes
        function sendMessage() {
            const formData = new FormData(document.getElementById('composeForm'));
            const messageData = {
                recipients: formData.get('recipients'),
                ccRecipients: formData.get('ccRecipients'),
                bccRecipients: formData.get('bccRecipients'),
                subject: formData.get('subject'),
                body: quillEditor.root.innerHTML,
                priority: formData.get('priority'),
                attachments: attachments
            };

            // Validaciones
            if (!messageData.recipients || !messageData.subject) {
                alert('Por favor, completa los campos obligatorios (Para y Asunto).');
                return;
            }

            // Simular envío
            const newMessage = {
                id: Date.now(),
                folder: 'sent',
                from: 'emprendedor@empresa.com',
                to: messageData.recipients,
                subject: messageData.subject,
                body: messageData.body,
                priority: messageData.priority,
                isRead: true,
                isStarred: false,
                isImportant: messageData.priority === 'high',
                hasAttachments: attachments.length > 0,
                attachments: attachments.map(a => a.name),
                labels: [],
                createdAt: new Date().toISOString(),
                status: 'sent'
            };

            messages.push(newMessage);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('composeModal'));
            modal.hide();
            
            // Mostrar confirmación
            showNotification('Mensaje enviado correctamente', 'success');
            
            // Actualizar vista
            updateStats();
            if (currentFolder === 'sent') {
                renderMessages();
            }
        }

        function saveDraft() {
            const formData = new FormData(document.getElementById('composeForm'));
            const messageId = formData.get('messageId');
            
            const draftData = {
                id: messageId || Date.now(),
                folder: 'drafts',
                from: 'emprendedor@empresa.com',
                to: formData.get('recipients') || '',
                subject: formData.get('subject') || '(Sin asunto)',
                body: quillEditor.root.innerHTML,
                priority: formData.get('priority'),
                isRead: true,
                isStarred: false,
                isImportant: false,
                hasAttachments: attachments.length > 0,
                attachments: attachments.map(a => a.name),
                labels: [],
                createdAt: new Date().toISOString(),
                status: 'draft'
            };

            if (messageId) {
                // Actualizar borrador existente
                const index = messages.findIndex(m => m.id === parseInt(messageId));
                if (index !== -1) {
                    messages[index] = draftData;
                }
            } else {
                // Crear nuevo borrador
                messages.push(draftData);
                document.getElementById('messageId').value = draftData.id;
            }

            document.getElementById('isDraft').value = 'true';
            showNotification('Borrador guardado', 'info');
            updateStats();
        }

        function autoSaveDraft() {
            const modal = document.getElementById('composeModal');
            if (modal.classList.contains('show')) {
                const subject = document.getElementById('subject').value;
                const content = quillEditor.root.innerHTML;
                
                if (subject || content.trim() !== '<p><br></p>') {
                    saveDraft();
                }
            }
        }

        // Gestión de adjuntos
        function handleAttachments(event) {
            const files = Array.from(event.target.files);
            attachments = [...attachments, ...files];
            updateAttachmentList();
        }

        function updateAttachmentList() {
            const attachmentList = document.getElementById('attachmentList');
            attachmentList.innerHTML = '';

            attachments.forEach((file, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.innerHTML = `
                    <i class="fas fa-file text-primary"></i>
                    <span>${file.name}</span>
                    <span class="text-muted">(${formatFileSize(file.size)})</span>
                    <i class="fas fa-times attachment-remove" onclick="removeAttachment(${index})"></i>
                `;
                attachmentList.appendChild(attachmentItem);
            });
        }

        function removeAttachment(index) {
            attachments.splice(index, 1);
            updateAttachmentList();
        }

        // Programar mensaje
        function scheduleMessage() {
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            
            // Establecer fecha mínima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('scheduleDate').min = today;
            document.getElementById('scheduleDate').value = today;
            
            modal.show();
        }

        function confirmSchedule() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!date || !time) {
                alert('Por favor, selecciona fecha y hora.');
                return;
            }

            const scheduleDateTime = new Date(`${date}T${time}`);
            const now = new Date();
            
            if (scheduleDateTime <= now) {
                alert('La fecha y hora deben ser futuras.');
                return;
            }

            // Cerrar modal de programación
            const scheduleModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
            scheduleModal.hide();
            
            // Mostrar confirmación
            showNotification(`Mensaje programado para ${formatDateTime(scheduleDateTime.toISOString())}`, 'success');
            
            // Cerrar modal de composición
            const composeModal = bootstrap.Modal.getInstance(document.getElementById('composeModal'));
            composeModal.hide();
        }

        // Acciones de mensaje
        function toggleStar(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.isStarred = !message.isStarred;
                updateStats();
                renderMessages();
                if (selectedMessageId === messageId) {
                    renderMessageView(message);
                }
            }
        }

        function archiveMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.folder = 'archived';
                showNotification('Mensaje archivado', 'info');
                updateStats();
                renderMessages();
                
                // Limpiar vista si era el mensaje seleccionado
                if (selectedMessageId === messageId) {
                    selectedMessageId = null;
                    document.getElementById('messageView').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-envelope-open"></i>
                            <h5>Selecciona un mensaje</h5>
                            <p>Elige un mensaje de la lista para verlo aquí</p>
                        </div>
                    `;
                }
            }
        }

        function deleteMessage(messageId) {
            if (confirm('¿Estás seguro de que quieres eliminar este mensaje?')) {
                const message = messages.find(m => m.id === messageId);
                if (message) {
                    message.folder = 'trash';
                    showNotification('Mensaje movido a la papelera', 'warning');
                    updateStats();
                    renderMessages();
                    
                    if (selectedMessageId === messageId) {
                        selectedMessageId = null;
                        document.getElementById('messageView').innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-envelope-open"></i>
                                <h5>Selecciona un mensaje</h5>
                                <p>Elige un mensaje de la lista para verlo aquí</p>
                            </div>
                        `;
                    }
                }
            }
        }

        function refreshMessages() {
            showNotification('Actualizando mensajes...', 'info');
            // Simular actualización
            setTimeout(() => {
                showNotification('Mensajes actualizados', 'success');
            }, 1000);
        }

        // Funciones auxiliares
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays <= 7) {
                return date.toLocaleDateString('es-ES', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getTextSnippet(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const text = tempDiv.textContent || tempDiv.innerText || '';
            return text.length > 100 ? text.substring(0, 100) + '...' : text;
        }

        function isToday(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function downloadAttachment(filename) {
            // Simular descarga de adjunto
            showNotification(`Descargando ${filename}...`, 'info');
        }

        function showNotification(message, type = 'info') {
            // Crear notificación toast
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'info' ? 'primary' : type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remover del DOM después de que se oculte
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
    </script>
</body>
</html>